# IAM Service Account for LLM Observatory
# Least-privilege access for Cloud Run service

# Create with:
# gcloud iam service-accounts create llm-observatory-sa \
#   --display-name="LLM Observatory Service Account" \
#   --description="Service account for LLM Observatory Cloud Run service"

apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMServiceAccount
metadata:
  name: llm-observatory-sa
  namespace: agentics-dev
spec:
  displayName: LLM Observatory Service Account
  description: Least-privilege service account for LLM Observatory Cloud Run service

---
# Required roles for the service account:

# 1. Cloud Run Invoker (for internal service-to-service calls)
# gcloud projects add-iam-policy-binding PROJECT_ID \
#   --member="serviceAccount:llm-observatory-sa@PROJECT_ID.iam.gserviceaccount.com" \
#   --role="roles/run.invoker"

# 2. Secret Manager Secret Accessor (for RUVECTOR_API_KEY)
# gcloud projects add-iam-policy-binding PROJECT_ID \
#   --member="serviceAccount:llm-observatory-sa@PROJECT_ID.iam.gserviceaccount.com" \
#   --role="roles/secretmanager.secretAccessor"

# 3. Cloud Trace Agent (for distributed tracing)
# gcloud projects add-iam-policy-binding PROJECT_ID \
#   --member="serviceAccount:llm-observatory-sa@PROJECT_ID.iam.gserviceaccount.com" \
#   --role="roles/cloudtrace.agent"

# 4. Logs Writer (for Cloud Logging)
# gcloud projects add-iam-policy-binding PROJECT_ID \
#   --member="serviceAccount:llm-observatory-sa@PROJECT_ID.iam.gserviceaccount.com" \
#   --role="roles/logging.logWriter"

# 5. Monitoring Metric Writer (for Cloud Monitoring)
# gcloud projects add-iam-policy-binding PROJECT_ID \
#   --member="serviceAccount:llm-observatory-sa@PROJECT_ID.iam.gserviceaccount.com" \
#   --role="roles/monitoring.metricWriter"

# ============================================================================
# PROHIBITED ROLES (Constitutional Requirement)
# ============================================================================
# The following roles MUST NOT be assigned:
# - roles/cloudsql.client (NO direct SQL access)
# - roles/cloudsql.admin (NO database management)
# - roles/storage.admin (NO storage management)
# - roles/pubsub.publisher (NO event publishing)
# - roles/workflows.invoker (NO workflow execution)
#
# LLM-Observatory is OBSERVATION-ONLY and does NOT:
# - Execute workflows
# - Trigger remediation or orchestration
# - Connect directly to databases
