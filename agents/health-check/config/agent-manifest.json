{
  "$schema": "https://llm-observatory.dev/schemas/agent-manifest.v1.json",
  "agentId": "health-check-agent",
  "agentVersion": "1.0.0",
  "name": "Health Check Agent",
  "description": "Continuously evaluates the health state of services and agents based on telemetry-derived indicators. Produces discrete health states (healthy, degraded, unhealthy), tracks health trends over time, and persists health evaluations for visibility and audit.",

  "classification": "ADVISORY",
  "actuating": false,

  "decisionType": "health_evaluation",
  "confidenceType": "statistical",
  "confidenceRange": {
    "min": 0.0,
    "max": 1.0
  },
  "constraintsApplied": [],

  "constitutionalConstraints": {
    "mustNot": [
      "Trigger alerts",
      "Initiate remediation actions",
      "Change execution behavior or routing",
      "Directly access database (use ruvector-service only)",
      "Execute SQL statements",
      "Invoke other agents",
      "Modify thresholds at runtime"
    ],
    "must": [
      "Validate all inputs against agentics-contracts schemas",
      "Emit exactly ONE DecisionEvent per invocation to ruvector-service",
      "Return deterministic, machine-readable output",
      "Expose CLI-invokable endpoint for inspection/replay",
      "Be deployable as a Google Edge Function",
      "Use statistical confidence based on sample size and indicator consistency"
    ]
  },

  "inputs": [
    {
      "type": "TelemetryAggregates",
      "source": "ruvector-service",
      "description": "Aggregated telemetry metrics (latency, error rate, throughput)",
      "schema": {
        "$ref": "#/definitions/TelemetryAggregatesInput"
      }
    },
    {
      "type": "FailureClassifications",
      "source": "ruvector-service",
      "description": "Classified failure events from failure-classification-agent",
      "optional": true
    },
    {
      "type": "HistoricalHealthStates",
      "source": "ruvector-service",
      "description": "Previous health evaluations for trend detection",
      "optional": true
    }
  ],

  "outputs": [
    {
      "type": "HealthEvaluation",
      "destination": "ruvector-service",
      "description": "Complete health evaluation with state, indicators, and trends",
      "schema": {
        "$ref": "#/definitions/HealthEvaluation"
      }
    },
    {
      "type": "DecisionEvent",
      "destination": "ruvector-service",
      "description": "Constitutional decision event record",
      "schema": {
        "$ref": "#/definitions/HealthCheckDecisionEvent"
      }
    }
  ],

  "consumers": [
    {
      "agentId": "dashboard-renderer",
      "eventTypes": ["HealthEvaluation"],
      "priority": "HIGH",
      "queueStrategy": "LATEST",
      "description": "Real-time health visualization"
    },
    {
      "agentId": "governance-view-agent",
      "eventTypes": ["HealthEvaluation", "DecisionEvent"],
      "priority": "MEDIUM",
      "queueStrategy": "BATCH",
      "description": "Compliance and audit reporting"
    },
    {
      "agentId": "slo-sla-enforcement-agent",
      "eventTypes": ["HealthEvaluation"],
      "priority": "HIGH",
      "queueStrategy": "LATEST",
      "description": "Health state input for SLO/SLA threshold evaluation"
    },
    {
      "agentId": "post-mortem-generator-agent",
      "eventTypes": ["HealthEvaluation"],
      "priority": "LOW",
      "queueStrategy": "BATCH",
      "description": "Historical health data for incident analysis"
    }
  ],

  "httpEndpoints": [
    {
      "method": "POST",
      "path": "/evaluate",
      "description": "Evaluate health for specified targets",
      "rateLimit": "100 req/min per IP",
      "input": "HealthEvaluationRequest",
      "output": "HealthEvaluationResponse"
    },
    {
      "method": "POST",
      "path": "/evaluate/batch",
      "description": "Batch health evaluation for multiple targets",
      "rateLimit": "20 req/min per IP",
      "input": "BatchHealthEvaluationRequest",
      "output": "BatchHealthEvaluationResponse"
    },
    {
      "method": "GET",
      "path": "/health",
      "description": "Agent health check endpoint",
      "rateLimit": "1000 req/min per IP"
    },
    {
      "method": "GET",
      "path": "/metrics",
      "description": "Prometheus metrics endpoint",
      "rateLimit": "100 req/min per IP"
    }
  ],

  "healthChecks": [
    {
      "name": "ruvector-connectivity",
      "interval": "30s",
      "timeout": "5s",
      "description": "Verify connectivity to ruvector-service"
    },
    {
      "name": "schema-validation",
      "interval": "60s",
      "timeout": "10s",
      "description": "Validate schema registry accessibility"
    }
  ],

  "cliCommands": [
    {
      "name": "evaluate",
      "usage": "npx @llm-observatory/cli health-check evaluate --target-type=<type> --target-id=<id> [--window=5m]",
      "description": "Run health evaluation for a target"
    },
    {
      "name": "inspect",
      "usage": "npx @llm-observatory/cli health-check inspect --evaluation-id=<uuid>",
      "description": "Inspect a past health evaluation"
    },
    {
      "name": "replay",
      "usage": "npx @llm-observatory/cli health-check replay --evaluation-id=<uuid> [--compare]",
      "description": "Replay evaluation for determinism verification"
    },
    {
      "name": "status",
      "usage": "npx @llm-observatory/cli health-check status [--detailed]",
      "description": "Check agent health and metrics"
    },
    {
      "name": "trends",
      "usage": "npx @llm-observatory/cli health-check trends --target-id=<id> [--window=24h] [--indicator=<type>]",
      "description": "View health trends over time"
    },
    {
      "name": "export",
      "usage": "npx @llm-observatory/cli health-check export [--format=json|csv] [--output=<file>]",
      "description": "Export health data"
    }
  ],

  "thresholds": {
    "latency": {
      "healthy_max_p95_ms": 500,
      "degraded_max_p95_ms": 2000,
      "description": "P95 latency thresholds in milliseconds"
    },
    "error_rate": {
      "healthy_max_percentage": 1,
      "degraded_max_percentage": 5,
      "description": "Error rate thresholds as percentage"
    },
    "throughput": {
      "healthy_min_rps": 10,
      "degraded_min_rps": 1,
      "description": "Throughput thresholds in requests per second"
    },
    "saturation": {
      "healthy_max_percentage": 70,
      "degraded_max_percentage": 90,
      "description": "Resource saturation thresholds as percentage"
    },
    "availability": {
      "healthy_min_percentage": 99.9,
      "degraded_min_percentage": 99.0,
      "description": "Availability thresholds as percentage"
    }
  },

  "hysteresis": {
    "threshold_to_improve": 3,
    "threshold_to_degrade": 1,
    "description": "Consecutive samples required for state transition (quick degrade, slow improve)"
  },

  "indicatorWeights": {
    "error_rate": 3.0,
    "availability": 2.5,
    "latency": 2.0,
    "throughput": 1.5,
    "saturation": 1.0,
    "description": "Weights for composite health state calculation"
  },

  "definitions": {
    "TelemetryAggregatesInput": {
      "type": "object",
      "properties": {
        "target_id": { "type": "string" },
        "target_type": { "type": "string", "enum": ["service", "agent", "provider", "endpoint"] },
        "window_start": { "type": "string", "format": "date-time" },
        "window_end": { "type": "string", "format": "date-time" },
        "request_count": { "type": "integer", "minimum": 0 },
        "error_count": { "type": "integer", "minimum": 0 },
        "latency_avg_ms": { "type": "number", "minimum": 0 },
        "latency_p50_ms": { "type": "number", "minimum": 0 },
        "latency_p90_ms": { "type": "number", "minimum": 0 },
        "latency_p95_ms": { "type": "number", "minimum": 0 },
        "latency_p99_ms": { "type": "number", "minimum": 0 }
      },
      "required": ["target_id", "target_type", "window_start", "window_end", "request_count", "error_count", "latency_avg_ms"]
    },
    "HealthEvaluation": {
      "type": "object",
      "properties": {
        "evaluation_id": { "type": "string", "format": "uuid" },
        "evaluated_at": { "type": "string", "format": "date-time" },
        "target": { "$ref": "#/definitions/Target" },
        "overall_state": { "type": "string", "enum": ["healthy", "degraded", "unhealthy"] },
        "overall_trend": { "type": "string", "enum": ["improving", "stable", "degrading", "volatile"] },
        "overall_confidence": { "type": "number", "minimum": 0, "maximum": 1 },
        "indicators": { "type": "array", "items": { "$ref": "#/definitions/HealthIndicator" } },
        "statistics": { "$ref": "#/definitions/AggregateStatistics" }
      },
      "required": ["evaluation_id", "evaluated_at", "target", "overall_state", "overall_trend", "overall_confidence", "indicators", "statistics"]
    },
    "HealthCheckDecisionEvent": {
      "type": "object",
      "properties": {
        "agent_id": { "type": "string", "const": "health-check-agent" },
        "agent_version": { "type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+$" },
        "decision_type": { "type": "string", "const": "health_evaluation" },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
        "constraints_applied": { "type": "array", "maxItems": 0 },
        "classification": { "type": "string", "const": "advisory" },
        "inputs_hash": { "type": "string", "minLength": 64, "maxLength": 64 },
        "outputs": { "type": "array", "items": { "$ref": "#/definitions/HealthEvaluation" }, "minItems": 1 },
        "execution_ref": { "type": "string", "minLength": 1 },
        "timestamp": { "type": "string", "format": "date-time" }
      },
      "required": ["agent_id", "agent_version", "decision_type", "confidence", "constraints_applied", "classification", "inputs_hash", "outputs", "execution_ref", "timestamp"]
    },
    "Target": {
      "type": "object",
      "properties": {
        "type": { "type": "string", "enum": ["service", "agent", "provider", "endpoint"] },
        "id": { "type": "string", "minLength": 1 },
        "name": { "type": "string", "minLength": 1 },
        "version": { "type": "string" }
      },
      "required": ["type", "id", "name"]
    },
    "HealthIndicator": {
      "type": "object",
      "properties": {
        "indicator_type": { "type": "string", "enum": ["latency", "error_rate", "throughput", "saturation", "availability"] },
        "current_value": { "type": "number" },
        "unit": { "type": "string" },
        "state": { "type": "string", "enum": ["healthy", "degraded", "unhealthy"] },
        "state_reason": { "type": "string" },
        "sample_size": { "type": "integer", "minimum": 0 },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 }
      },
      "required": ["indicator_type", "current_value", "unit", "state", "state_reason", "sample_size", "confidence"]
    },
    "AggregateStatistics": {
      "type": "object",
      "properties": {
        "total_requests": { "type": "integer", "minimum": 0 },
        "total_errors": { "type": "integer", "minimum": 0 },
        "avg_latency_ms": { "type": "number", "minimum": 0 },
        "error_rate_percentage": { "type": "number", "minimum": 0, "maximum": 100 },
        "availability_percentage": { "type": "number", "minimum": 0, "maximum": 100 },
        "sample_size": { "type": "integer", "minimum": 0 }
      },
      "required": ["total_requests", "total_errors", "avg_latency_ms", "error_rate_percentage", "availability_percentage", "sample_size"]
    }
  }
}
