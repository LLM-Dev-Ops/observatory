# Failure Classification Agent - Google Cloud Functions Configuration
#
# CONSTITUTIONAL CLASSIFICATION: READ-ONLY, DIAGNOSTIC
#
# This agent is deployed as a Google Cloud Function (Gen2)
# It processes failure events and classifies them into categories
# It persists decision events to ruvector-service ONLY

name: failure-classification-agent
runtime: nodejs20
entryPoint: handleClassification

# Resource Configuration
memory: 256MB
cpu: 1
timeout: 30s
minInstances: 0
maxInstances: 100
concurrency: 100

# HTTP Trigger Configuration
trigger:
  type: http
  invoker: allUsers  # Adjust for production

# Environment Variables
environmentVariables:
  # Agent Identification
  AGENT_ID: failure-classification-agent
  AGENT_VERSION: "1.0.0"
  AGENT_CLASSIFICATION: READ-ONLY

  # RuVector Service Configuration
  RUVECTOR_ENDPOINT: https://ruvector-service.internal:443
  RUVECTOR_TIMEOUT: "30000"
  RUVECTOR_RETRY_ATTEMPTS: "3"
  RUVECTOR_RETRY_DELAY_MS: "1000"
  RUVECTOR_MAX_RETRY_DELAY_MS: "10000"
  RUVECTOR_CONNECTION_POOL_SIZE: "5"

  # Processing Configuration
  BATCH_SIZE: "100"
  TIMEOUT_MS: "30000"
  MAX_PAYLOAD_SIZE_BYTES: "10485760"

  # Feature Flags
  SCHEMA_VALIDATION_ENABLED: "true"
  SELF_OBSERVATION_ENABLED: "true"

  # Retry Configuration
  MAX_RETRIES: "3"
  RETRY_BACKOFF_MS: "100"

  # Node.js Configuration
  NODE_ENV: production
  LOG_LEVEL: info

# Secret Environment Variables
secretEnvironmentVariables:
  - key: RUVECTOR_API_KEY
    secret: ruvector-api-key
    version: latest

# VPC Configuration (for internal service access)
vpcConnector: projects/llm-observatory/locations/us-central1/connectors/observatory-vpc
vpcConnectorEgressSettings: PRIVATE_RANGES_ONLY

# Ingress Settings
ingressSettings: ALLOW_INTERNAL_AND_GCLB

# Service Account
serviceAccount: failure-classification-agent@llm-observatory.iam.gserviceaccount.com

# Labels
labels:
  app: llm-observatory
  component: failure-classification-agent
  classification: read-only
  tier: diagnostic
  team: observatory

# Build Configuration
buildConfig:
  runtime: nodejs20
  source:
    storageSource:
      bucket: llm-observatory-functions
      object: failure-classification-agent.zip
  entryPoint: handleClassification
  environmentVariables:
    NODE_ENV: production

# Health Check Configuration
healthCheck:
  path: /health
  method: GET
  expectedStatus: 200
  interval: 30s
  timeout: 5s

---
# Staging Environment Override
# Apply with: gcloud functions deploy failure-classification-agent-staging --config cloudfunctions.yaml --flags-file staging-flags.yaml
stagingOverrides:
  name: failure-classification-agent-staging
  minInstances: 0
  maxInstances: 10
  environmentVariables:
    RUVECTOR_ENDPOINT: https://ruvector-service-staging.internal:443
    NODE_ENV: staging
    LOG_LEVEL: debug
    SELF_OBSERVATION_ENABLED: "true"
  labels:
    environment: staging
